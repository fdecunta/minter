---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# minter <img src="man/figures/minter_logo.png" align="right" alt="" width="130" />

<!-- badges: start -->
[![R-CMD-check](https://github.com/fdecunta/minter/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/fdecunta/minter/actions/workflows/R-CMD-check.yaml)
[![Codecov test coverage](https://codecov.io/gh/fdecunta/minter/graph/badge.svg)](https://app.codecov.io/gh/fdecunta/minter)
<!-- badges: end -->


Helper functions for conducting meta-analyses of interactions in 2Ã—2 factorial experiments.


## Installation

You can install the development version of minter from [GitHub](https://github.com/fdecunta/minter):

``` r
devtools::install_github("fdecunta/minter", force = TRUE)
```

## Example

### Effect Sizes for factorial meta-analysis

The function `factorial_effsize()` computes five effect sizes from the data of a factorial experiment:

- **Two simple effects**:  
  - The effect of Factor A relative to the Control  
  - The effect of Factor B relative to the Control  

- **Two overall effects**:  
  - The overall effect of Factor A across levels of Factor B  
  - The overall effect of Factor B across levels of Factor A  

- **One interaction effect**:  
  - The effect size of the interaction between Factors A and B


```{r example}
library(minter)

# Load fake data from a 2-by-2 factorial experiment:
# - Insect herbivory (Herb)
# - Fertilization (Fert)
data(fake_data)

# Compute the effect sizes
fake_data <- factorial_effsize(
  effsize = "lnrr",
  colnames = c("Herb", "Fert"),
  data = fake_data,
  Ctrl_mean = C_mean,
  Ctrl_sd = C_sd,
  Ctrl_n = C_n,
  A_mean = Herb_mean,
  A_sd = Herb_sd,
  A_n = Herb_n,
  B_mean = Fert_mean,
  B_sd = Fert_sd,
  B_n = Fert_n,
  AB_mean = HxF_mean,
  AB_sd = HxF_sd,
  AB_n = HxF_n
)

str(fake_data)
```

### Multiple VCVs for non-independence

Effect sizes are often not independent. In such cases, it is useful to use an estimated variance-covariance matrix to account for the non-independence among sampling variances.

For multiple effect sizes you need multiple matrices. The function `factorial_vcv()` helps to calculate all of them at once:

```{r}
vi_cols <- c(
  "Herb_simple_lnRR_var",
  "Fert_simple_lnRR_var",
  "Herb_overall_lnRR_var",
  "Fert_overall_lnRR_var",
  "Herb_x_Fert_lnRR_var"
)

VCVs <- factorial_vcv(
  vi_cols = vi_cols,
  cluster = Study,
  obs = EffectSize_ID,
  rho = 0.5,
  data = fake_data
)

str(VCVs)
```

To use a specific VCV matrix, just reference it using '$':

```{r}
# Overall effect of Insect Herbivores
res_herb <- metafor::rma.mv(
  yi = Herb_overall_lnRR,
  V  = VCVs$Herb_overall_lnRR_var,
  random = ~ 1 | Study,
  test = "t",
  data = fake_data)

# Overall effect of Fertilization
res_fert <- metafor::rma.mv(
  yi = Fert_overall_lnRR,
  V  = VCVs$Fert_overall_lnRR_var,
  random = ~ 1 | Study,
  test = "t",
  data = fake_data)

# Interaction effect 
res_intr <- metafor::rma.mv(
  yi = Herb_x_Fert_lnRR,
  V  = VCVs$Herb_x_Fert_lnRR_var,
  random = ~ 1 | Study,
  test = "t",
  data = fake_data)
```

To visualize the results of multiple modles you need to aggregate them. `factorial_mod_results()` do this:


```{r}
# factorial_mod_results() uses orchaRd::mod_results() internally
# library(orchaRd) 

models <- list(
  "Insect herbivory" = res_herb,
  "Fertilization" = res_fert,
  "Interaction" = res_intr
)

res_table <- factorial_mod_results(
  models = models,
  group = "Study"
)

res_table
```


You may want to visualize these results, and the `orchaRd` package provides excellent tools for this.
To support this, `minter` is designed to work seamlessly with `orchaRd`.

The function `factorial_mod_results()` returns an object of class `orchaRd`, which can be used directly with `orchaRd::orchard_plot()`:


```{r, fig.width=6}
orchaRd::orchard_plot(
  res_table,
  group = "Study",
  xlab = "lnRR",
  legend.pos = "top.out",
  angle = 0
)
```
