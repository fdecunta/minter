## Loading data and functions

This loads the unprocessed data file and custom functions including

-   functions for calculating 'focal' effect sizes and variance for lnRR and SMD: `effect_set`
-   functions for calculating 'pairwise' comparisons (lnRR) and variance: `effect_set2`
-   functions for calculating 'focal' effect sizes and variance for lnRR without arcsine transformation: `effect_setb`
-   functions for calculating pair-wise contrasts between moderators: `contrast_fun`

```{r}
library(tidyverse)
library(metafor)
library(clubSandwich)
```


```{r, cache = FALSE}
dat <- read_csv("Data/Macartney2022_raw.csv")
# Load custom function to extract data 
source("Macarney_Functions.R")
```

## Data organisation

-   removing one study (Wang et al. 2020) with negative values as lnRR cannot be calculated with negative values
-   rounding down sample sizes that are coded as decimals due to averaging sample sizes across treatments
-   calculating effect sizes using custom functions
-   'flipping' effect sizes so that all effect sizes that are higher values can be interpreted as individuals performing better in cognitive assays
-   assigning human readable terms to moderators initially coded as numbers
-   creating a variance-covariance matrix (VCV)
-   adding column of author and year for leave-one-group-out analysis

```{r}
# removing study with negative values as these are unable to be used for lnRR
dat <- droplevels(dat[!dat$First_author == 'Wang',])

#rounding down sample sizes
dat$CC_n <- floor(dat$CC_n)
dat$EC_n <- floor(dat$EC_n)
dat$CS_n <- floor(dat$CS_n)
dat$ES_n <- floor(dat$CS_n)
```


```{r}
# 'Focal' effect_size 
effect_size <- with(dat, mapply(effect_set, 
                      CC_n ,
                      CC_mean, 
                      CC_SD,
                      EC_n, 
                      EC_mean, 
                      EC_SD,
                      CS_n, 
                      CS_mean, 
                      CS_SD,
                      ES_n, 
                      ES_mean, 
                      ES_SD,
                      percent = Response_percent,
                      SIMPLIFY = FALSE))
effect_size <- map_dfr(effect_size, I)
```


```{r}
# 'Pairwise' effect size
 effect_size2 <- with(dat, mapply(effect_set2, 
                      CC_n ,
                      CC_mean, 
                      CC_SD,
                      EC_n, 
                      EC_mean, 
                      EC_SD,
                      CS_n, 
                      CS_mean, 
                      CS_SD,
                      ES_n, 
                      ES_mean, 
                      ES_SD,
                      percent = Response_percent,
                      SIMPLIFY = FALSE))
effect_size2 <- map_dfr(effect_size2, I)
```


```{r}
#without transformation of percent data for sensitivity analysis

 effect_sizeb <- with(dat, mapply(effect_setb, 
                      CC_n ,
                      CC_mean, 
                      CC_SD,
                      EC_n, 
                      EC_mean, 
                      EC_SD,
                      CS_n, 
                      CS_mean, 
                      CS_SD,
                      ES_n, 
                      ES_mean, 
                      ES_SD,
                      SIMPLIFY = FALSE))
effect_sizeb <- map_dfr(effect_sizeb, I)

full_info <- which(complete.cases(effect_size) == TRUE)

# adding effect sizes as column
dat <- bind_cols(dat, effect_size, effect_size2, effect_sizeb)
dat <- dat[full_info, ]
```


```{r}
#Flipping 'lower is better' to 'higher is better' effect sizes
#flipping lnRR for values where higher = worse
dat$lnRR_Ea <- ifelse(dat$Response_direction == 2, dat$lnRR_E*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_E))
dat$lnRR_Sa  <- ifelse(dat$Response_direction == 2, dat$lnRR_S*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_S)) 
dat$lnRR_ESa <-  ifelse(dat$Response_direction == 2, dat$lnRR_ES*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_ES)) 
#flipping 'pure effect sizes'
dat$lnRR_E2a <- ifelse(dat$Response_direction == 2, dat$lnRR_E2*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_E2)) 
dat$lnRR_S2a  <- ifelse(dat$Response_direction == 2, dat$lnRR_S2*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_S2)) 
dat$lnRR_ES2a <-  ifelse(dat$Response_direction == 2, dat$lnRR_ES2*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_ES2)) 
dat$lnRR_E3a <-  ifelse(dat$Response_direction == 2, dat$lnRR_E3*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_E3)) 
dat$lnRR_S3a <-  ifelse(dat$Response_direction == 2, dat$lnRR_S3*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_S3))

#flipping SMD
dat$SMD_Ea <- ifelse(dat$Response_direction == 2, dat$SMD_E*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$SMD_E)) 
dat$SMD_Sa  <- ifelse(dat$Response_direction == 2, dat$SMD_S*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$SMD_S)) 
dat$SMD_ESa <-  ifelse(dat$Response_direction == 2, dat$SMD_ES*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$SMD_ES))

#flipping non-transformed percent
dat$lnRR_E_b <- ifelse(dat$Response_direction == 2, dat$lnRR_Eb*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_Eb)) 
dat$lnRR_S_b <- ifelse(dat$Response_direction == 2, dat$lnRR_Sb*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_Sb)) 
dat$lnRR_ES_b <-  ifelse(dat$Response_direction == 2, dat$lnRR_ESb*-1,ifelse(is.na(dat$Response_direction) == TRUE, NA, dat$lnRR_ESb))
```


```{r}
#making variance VCVs
VCV_E <- impute_covariance_matrix(vi = dat$lnRRV_E, cluster = dat$Study_ID, r = 0.5)
VCV_S <- impute_covariance_matrix(vi = dat$lnRRV_S, cluster = dat$Study_ID, r = 0.5)
VCV_ES <- impute_covariance_matrix(vi = dat$lnRRV_ES, cluster = dat$Study_ID, r = 0.5)

VCV_E_a <- impute_covariance_matrix(vi = dat$SMDV_E, cluster = dat$Study_ID, r = 0.5)
VCV_S_a <- impute_covariance_matrix(vi = dat$SMDV_S, cluster = dat$Study_ID, r = 0.5)
VCV_ES_a <- impute_covariance_matrix(vi = dat$SMDV_ES, cluster = dat$Study_ID, r = 0.5)

VCV_E_b <- impute_covariance_matrix(vi = dat$lnRRV_Eb, cluster = dat$Study_ID, r = 0.5)
VCV_S_b <- impute_covariance_matrix(vi = dat$lnRRV_Sb, cluster = dat$Study_ID, r = 0.5)
VCV_ES_b <- impute_covariance_matrix(vi = dat$lnRRV_ESb, cluster = dat$Study_ID, r = 0.5)
```


```{r}
dat$Year_published <- as.factor(dat$Year_published)
dat$Study_ID <- as.factor(dat$Study_ID)

dat<- dat %>% mutate(leave_out = paste(First_author, Year_published, sep = "_"))
dat$leave_out<- as.factor(dat$leave_out)
dat$Year_published <- as.integer(dat$Year_published)

#write.csv(dat, file = here("Data", 'Data_processed.csv'), row.names = TRUE)
```

# Modelling with lnRR

## Main effect: environmental enrichment

### Meta-analysis

To quantify differences in individual performance in cognitive assays with environmental enrichment, we used the logarithm of response ratio (lnRR) calculated as:

$$
\ln{\text{RR}_\text{EE}} = 
\ln\left( \frac{ M_\text{ES} +  M_\text{EC}} {2} \right) - 
\ln\left( \frac {M_\text{CS} +  M_\text{CC}} {2} \right) = \ln \left(
{\frac {M_\text{ES} + M_\text{EC}} {M_\text{CS} + M_\text{CC}}} 
 \right),
$$

Variance was calculated as:

$$
\text{var}(\ln{\text{RR}_\text{EE}}) = 
\left( 
\frac{1} { M_\text{ES} + M_\text{EC} } 
\right)^2
\left(
\frac{SD_\text{ES}^2}{N_\text{ES}} + \frac{SD_\text{EC}^2}{N_\text{EC}}
\right) + \left( \frac {1} {  M_\text{CS} +  M_\text{CC} } \right)^2
\left(\frac{SD_\text{CS}^2}{N_\text{CS}} + \frac{SD_\text{CC}^2}{n_\text{CC}}
\right)
$$ Variance was converted in to variance-covariance (VCV) matrix (see above in 'Data organisation') to control for non-independence in sampling variances from the same studies.

```{r}
#dat <- read_csv(here("Data","Data_processed.csv"))

mod_E0 <- rma.mv(yi = lnRR_Ea, V = VCV_E, random = list(~1|Study_ID,
                                                          ~1|ES_ID,
                                                          ~1|Strain),
                 test = "t",
                 data = dat)
summary(mod_E0) 
i2_ml(mod_E0) 
```

Figure corresponds to Fig. 3A in main text

```{r}
orchard_plot(mod_E0, mod = "Int", xlab = "lnRR", alpha=0.4) +  # Orchard plot 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5)+ # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2)+ # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_colour_manual(values = "darkorange")+ # change colours
  scale_fill_manual(values="darkorange")+ 
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 

```

**Fig. S3** Orchard plot showing meta-analytic mean, 95% confidence interval (thick black line), and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

### Meta-regression: uni-moderator {.tabset}

To explain some of the unexplained variation in the main effect of environmental enrichment meta-analytic model, we conducted a series of uni-moderator analyses. We calculated marginal R\^2 for each moderator, as well as conducted a series of pair-wise contrasts between moderator categories.

Any moderator categories with k \< 5 were removed.

#### Learning vs Memory

Was the measured response interpreted as learning or memory?

```{r}
mod_E1 <-  rma.mv(yi = lnRR_Ea, V = VCV_E, mod = ~Learning_vs_memory-1, random = list(~1|Study_ID,
                                                                                        ~1|ES_ID,
                                                                                        ~1|Strain),
                  test = "t",
                  data = dat)

summary(mod_E1) 
r2_ml(mod_E1) 
```

Figure corresponds to Fig. 4A in main text

```{r}
LvsM_E <- orchard_plot(mod_E1, mod = "Learning_vs_memory", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  xlim(-0.5, 2) + 
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21) + # mean estimate
  scale_size_continuous(range = c(1, 7)) + # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

LvsM_E
```

**Fig. S4a** Orchard plot showing the group-wise means of the categorical variable 'Learning_vs_memory' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_E1 <- contrast_fun(data = dat, response = lnRR_Ea, moderator = Learning_vs_memory, VCV = VCV_E)
res_table_mod_E1 <- get_estimate(model = mod_E1, contra = contra_mod_E1, moderator = Learning_vs_memory)

res_table_mod_E1
```

#### Type of assay

The broad category of the type of assay used to measure learning or memory.

```{r}
dat1 <- filter(dat, Type_assay %in% c("Recognition", "Habituation", "Conditioning"))
VCV_E1 <- impute_covariance_matrix(vi = dat1$lnRRV_E, cluster = dat$Study_ID, r = 0.5)

mod_E2 <- rma.mv(yi = lnRR_Ea, V = VCV_E1, mod = ~Type_assay-1, random = list(~1|Study_ID,
                                                                                  ~1|ES_ID,
                                                                                  ~1|Strain),
                 test = "t",
                 data = dat1)

summary(mod_E2)
r2_ml(mod_E2) 
```

Figure corresponds to Fig. 4B in main text

```{r}

Learning_E <- orchard_plot(mod_E2, mod = "Type_assay", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  xlim(-0.5, 2) + 
  scale_colour_manual(values = c("grey34","grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34", "grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
    geom_signif(comparisons = list(c("Conditioning", "Recognition")),
              annotations = "*") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

Learning_E
```

**Fig. S4b** Orchard plot showing the group-wise means of the categorical variable 'Type_assay' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_E2 <- contrast_fun(data = dat1, response = lnRR_Ea, moderator = Type_assay, VCV = VCV_E1)
res_table_mod_E2 <- get_estimate(model = mod_E2, contra = contra_mod_E2, moderator = Type_assay)

res_table_mod_E2
```

#### Type of reinforcement

If conditioning was used, was aversive or appetitive reinforcement used?

```{r}

dat2 <- filter(dat, Type_reinforcement %in% c("Appetitive", "Aversive", "Not applicable"))
VCV_E2 <- impute_covariance_matrix(vi = dat2$lnRRV_E, cluster = dat2$Study_ID, r = 0.5)
mod_E3 <- rma.mv(yi = lnRR_Ea, V = VCV_E2, mod = ~ Type_reinforcement-1, random = list(~1|Study_ID,
                                                                                            ~1|ES_ID,
                                                                                            ~1|Strain),
                 test = "t",
                 data = dat2)

summary(mod_E3)
r2_ml(mod_E3) 
```

Figure corresponds to Fig. 4C in main text

```{r}
Reinforcement_E <-orchard_plot(mod_E3, mod = "Type_reinforcement", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  xlim(-0.5, 2) + 
  scale_colour_manual(values = c("grey34","grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34", "grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
    geom_signif(comparisons = list(c("Aversive", "Not applicable")),
              annotations = "*") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

Reinforcement_E
```

**Fig. S4c** Orchard plot showing the group-wise means of the categorical variable 'Type_reinforcement' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_E3 <- contrast_fun(data = dat2, response = lnRR_Ea, moderator = Type_reinforcement, VCV = VCV_E2)
res_table_mod_E3 <- get_estimate(model = mod_E3, contra = contra_mod_E3, moderator = Type_reinforcement)

res_table_mod_E3
```

#### Age at enrichment

The effect of age when individuals were exposed to environmental enrichment.

```{r}
dat3 <- filter(dat, Age_EE_exposure %in% c("Adult", "Adolescent"))
VCV_E3 <- impute_covariance_matrix(vi = dat3$lnRRV_E, cluster = dat3$Study_ID, r = 0.5)


mod_E4 <- rma.mv(yi = lnRR_Ea, V = VCV_E3, mod = ~Age_EE_exposure-1, random = list(~1|Study_ID,
                                                                                    ~1|ES_ID,
                                                                                    ~1|Strain),
                 test = "t",
                 data = dat3)

summary(mod_E4) 
r2_ml(mod_E4) 
```

Figure corresponds to Fig. 4D in main text

```{r, fig.width=10, fig.height=7}
Age_E<- orchard_plot(mod_E4, mod = "Age_EE_exposure", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  xlim(-0.5, 2) + 
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10))  

Age_E
```

**Fig. S4d** Orchard plot showing the group-wise means of the categorical variable 'Age_EE_exposure' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_E4 <- contrast_fun(data = dat3, response = lnRR_Ea, moderator = Age_EE_exposure, VCV = VCV_E3)
res_table_mod_E4 <- get_estimate(model = mod_E4, contra = contra_mod_E4, moderator = Age_EE_exposure)

res_table_mod_E4
```

#### Exercise enrichment

Did enrichment involve the addition of apparatus for voluntary exercise (e.g., a wheel or treadmill)?

```{r}
mod_E5 <- rma.mv(yi = lnRR_Ea, V = VCV_E, mod = ~EE_exercise-1, random = list(~1|Study_ID,
                                                                               ~1|ES_ID,
                                                                               ~1|Strain),
                test = "t",
                data = dat)

summary(mod_E5)
r2_ml(mod_E5) 
```

Figure corresponds to Fig. 4E in main text

```{r, fig.width=10, fig.height=7}
Exercise_E <-orchard_plot(mod_E5, mod = "EE_exercise", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  xlim(-0.5, 2) + 
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

Exercise_E
```

**Fig. S4e** Orchard plot showing the group-wise means of the categorical variable 'EE_exercise' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_E5 <- contrast_fun(data = dat, response = lnRR_Ea, moderator = EE_exercise, VCV = VCV_E)
res_table_mod_E5 <- get_estimate(model = mod_E5, contra = contra_mod_E5, moderator = EE_exercise)

res_table_mod_E5
```

#### Social enrichment

Did enrichment involve adding more conspecifics in the cage? (Note that we did not include studies that only provided social enrichment but no abiotic enrichment.)

```{r}
dat4 <- filter(dat, EE_social %in% c("Social", "Non-social"))
VCV_E4 <- impute_covariance_matrix(vi = dat4$lnRRV_E, cluster = dat4$Study_ID, r = 0.5)
  
mod_E6<- rma.mv(yi = lnRR_Ea, V = VCV_E4, mod = ~EE_social-1, random = list(~1|Study_ID, 
                                                                             ~1|ES_ID,
                                                                             ~1|Strain),
                test = "t",data = dat4)

summary(mod_E6)
r2_ml(mod_E6) 
```

Figure corresponds to Fig. 4F in main text

```{r, fig.width=10, fig.height=7}
Social_E <-orchard_plot(mod_E6, mod = "EE_social", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  xlim(-0.5, 2) + 
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
       text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

Social_E 
```

**Fig. S4f** Orchard plot showing the group-wise means of the categorical variable 'EE_social' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_E6 <- contrast_fun(data = dat4, response = lnRR_Ea, moderator = EE_social, VCV = VCV_E4)
res_table_mod_E6 <- get_estimate(model = mod_E5, contra = contra_mod_E6, moderator = EE_social)

res_table_mod_E6
```

### Publication bias & sensitivity analysis {.tabset}

#### Multi-moderator model

We ran a multi-moderator 'full' model of all moderators. We ran model selection based on AIC and selected the top set of models within delta AIC of 6 and calculated the importance of each moderator (i.e., Akaike weights) within this top model set.

```{r, eval = FALSE}
# filter data so that all K < 5 are removed
dat_Efm <- dat %>%
  filter(Type_assay %in% c("Recognition", "Habituation", "Conditioning"),
         Type_reinforcement %in% c("Appetitive", "Aversive", "Not applicable"),
         EE_social %in% c("Social", "Non-social"), 
         Age_EE_exposure %in% c("Adult", "Adolescent"))

#VCV_Efm <- impute_covariance_matrix(vi = dat_Efm$lnRRV_E, cluster = dat_Efm$Study_ID, r = 0.5)
                 
mod_Efm <- rma.mv(yi = lnRR_Sa, V = VCV_Efm, mod = ~Type_assay-1 + Learning_vs_memory + Type_reinforcement + EE_social + EE_exercise + Age_EE_exposure , random =   list(~1|Study_ID,
                                                                                    ~1|ES_ID,
                                                                                    ~1|Strain),
                    test = "t",
                 data = dat_Efm)
#summary(mod_Efm)
#r2_ml(mod_Efm) 

res_Efm <- dredge(mod_Efm, trace=2)
saveRDS(res_Efm, file = here("Rdata", "res_Efm.rds"))
# also saving the full model and data
saveRDS(mod_Efm, file = here("Rdata", "mod_Efm.rds"))
saveRDS(dat_Efm, file = here("Rdata", "dat_Efm.rds"))
```

The akaike weights for the top set of models with AIC \< 6

```{r}
dat_Efm <- readRDS(file = here("Rdata", "dat_Efm.rds"))
mod_Efm <- readRDS(file = here("Rdata", "mod_Efm.rds"))
res_Efm <- readRDS(file = here("Rdata", "res_Efm.rds"))
res_Efm2 <- subset(res_Efm, delta <= 6, recalc.weights=FALSE)
importance(res_Efm2)
```

#### Funnel plot

We used funnel plots of effect sizes against the residuals of the full model to visually inspect for funnel asymmetry.

Figure corresponds to Fig. 7A in main text

```{r}

# funnel plot
Funnel_E<-funnel(mod_Efm, xlab = "lnRR", ylab = "Standard Error")
#Funnel_E

```

**Fig.S5** Funnel plot showing the standard error and residuals (lnRR) from the full model.

#### Egger's regression and time-lag bias

We fitted effective sample size calculated as:

$$
\sqrt{\frac {1} { \tilde{N} }}  =
\sqrt{\frac {1} { N_\text{ES}} + \frac{1}{N_\text{EC}} + 
\frac {1}{N_\text{CS}} + \frac{1}{N_\text{CC}}},
$$

and year of publication as moderators in the full model to inferentially test for funnel asymmetry and a decrease in effect sizes with publication year.

```{r}
VCV_Efm <- impute_covariance_matrix(vi = dat_Efm$lnRRV_E, cluster = dat_Efm$Study_ID, r = 0.5)
dat_Efm$c_Year_published <- as.vector(scale(dat_Efm$Year_published, scale = F))

dat_Efm$sqrt_inv_e_n <- with(dat_Efm, sqrt(1/CC_n + 1/EC_n + 1/ES_n + 1/CS_n))

PB_MR_E<- rma.mv(lnRR_Sa, VCV_Efm, mods = ~1 + sqrt_inv_e_n +  Learning_vs_memory + Year_published + Type_assay + Type_reinforcement + EE_social + EE_exercise + Age_stress_exposure, random = list(~1|Study_ID,
                                                          ~1|ES_ID,
                                                          ~1|Strain), method = "REML", test = "t", 
    data = dat_Efm)

#PB_MR_E

estimates_PB_MR_E <- estimates.CI(PB_MR_E)
estimates_PB_MR_E
```

#### Leave-one-out analysis

We individually removed studies to determine if any singular studies have a disproportionate effect on the meta-analytic mean and CI.

```{r}
LeaveOneOut_effectsize <- list()
for(i in 1:length(levels(dat$leave_out))){
  
  d <- dat %>% filter(leave_out != levels(dat$leave_out)[i])
  
  VCV_Eb <- impute_covariance_matrix(vi = d$lnRRV_E, cluster = d$Study_ID, r = 0.5)
  
  LeaveOneOut_effectsize[[i]] <- rma.mv(yi = lnRR_Ea, V = VCV_Eb, 
                                        random = list(~1 | Study_ID,~1| ES_ID, ~1 | Strain), 
                                        method = "REML", data = dat[dat$leave_out
                                                                    != levels(dat$leave_out)[i], ])}


# writing function for extracting est, ci.lb, and ci.ub from all models
est.func <- function(mod_E0){
  df <- data.frame(est = mod_E0$b, lower = mod_E0$ci.lb, upper = mod_E0$ci.ub)
  return(df)
}


#using dplyr to form data frame
MA_CVR_E <- lapply(LeaveOneOut_effectsize, function(x) est.func(x))%>% bind_rows %>% mutate(left_out = levels(dat$leave_out))


#saveRDS(MA_CVR_E,file = here("Rdata", "MA_CVR_E.rds"))
```

Figure corresponds to Fig. S3 in Supplementary material S2.

```{r}

# MA_CVR_E <- readRDS(file = here("Rdata", "MA_CVR_E.rds"))

#telling ggplot to stop reordering factors
 MA_CVR_E$left_out <- as.factor(MA_CVR_E$left_out)
 MA_CVR_E$left_out <- factor(MA_CVR_E$left_out, levels = MA_CVR_E$left_out)


#plotting
leaveoneout_E <- ggplot(MA_CVR_E) +
  geom_hline(yintercept = 0, lty = 2, lwd = 1) +
  geom_hline(yintercept = mod_E0$ci.lb, lty = 3, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod_E0$b, lty = 1, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod_E0$ci.ub, lty = 3, lwd = 0.75, colour = "black") +
  geom_pointrange(aes(x = left_out, y = est, ymin = lower, ymax = upper)) +
  xlab("Study left out") + 
  ylab("lnRR, 95% CI") + 
  coord_flip() +
  theme(panel.grid.minor = element_blank())+
  theme_bw() + theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor.x = element_blank() ) +
  theme(axis.text.y = element_text(size = 6))

leaveoneout_E

# ggsave("leaveoneout_E.tiff", leaveoneout_E, dpi = 300) 

```

**Fig. S6** Leave-one-group-out analysis showing meta-analytic mean and 95% CI when each individual study is removed from the data set.

#### Using SMD

We re-ran the main effect of environmental enrichment meta-analytic model using standardised mean difference (SMD) instead of lnRR.

```{r}

mod_E0a <- rma.mv(yi = SMD_Ea, V = VCV_E_a, random = list(~1|Study_ID,
                                                         ~1|ES_ID, 
                                                         ~1|Strain),
                 test = "t",
                 data = dat)
summary(mod_E0a)
i2_ml(mod_E0a)

```

#### Using untransformed percent data

We re-ran the main effect of environmental enrichment meta-analytic model using un(arcsine)transformed percent data using lnRR.

```{r}
mod_E0b <- rma.mv(yi = lnRR_E_b, V = VCV_E_b, random = list(~1|Study_ID,
                                                         ~1|ES_ID, 
                                                         ~1|Strain),
                 test = "t",
                 data = dat)
summary(mod_E0b)
i2_ml(mod_E0b)
```

#### Risk of Bias

Testing a model including if the study was randomised as a moderator and conducting a pair-wise contrast analysis.

```{r, results = 'hide'}
mod_randomised_E <- rma.mv(yi = lnRR_Ea, V = VCV_E, mod = ~ROB_randomisation-1, random = list(~1|Study_ID, 
                                                                             ~1|ES_ID,
                                                                             ~1|Strain),
                test = "t",data = dat)

summary(mod_randomised_E)
r2_ml(mod_randomised_E) 

```

```{r}
contra_mod_randomised_E <- contrast_fun(data = dat, response = lnRR_Ea, moderator = ROB_randomisation, VCV = VCV_E)
res_table_mod_randomised_E <- get_estimate(model = mod_randomised_E, contra = contra_mod_randomised_E, moderator = ROB_randomisation)

res_table_mod_randomised_E
```

Testing a model including if the study used blinding as a moderator and conducting a pair-wise contrast analysis.

```{r, results = 'hide'}
mod_blinding_E <- rma.mv(yi = lnRR_Ea, V = VCV_E, mod = ~ROB_blinding-1, random = list(~1|Study_ID, 
                                                                             ~1|ES_ID,
                                                                             ~1|Strain),
                test = "t",data = dat)

summary(mod_blinding_E)
r2_ml(mod_blinding_E) 

```

```{r}
contra_mod_blinding_E <- contrast_fun(data = dat, response = lnRR_Ea, moderator = ROB_blinding, VCV = VCV_E)
res_table_mod_blinding_E <- get_estimate(model = mod_blinding_E, contra = contra_mod_blinding_E, moderator = ROB_blinding)

res_table_mod_blinding_E
```

## Main effect: stress

### Meta-analysis

To quantify differences in individual performance in cognitive assays with stress, we used the logarithm of response ratio (lnRR) calculated as:

$$
\ln{\text{RR}_\text{stress}} = 
\ln\left( \frac{ M_\text{ES} +  M_\text{CS}} {2} \right) - 
\ln\left( \frac {M_\text{EC} +  M_\text{CC}} {2} \right) = \ln \left(
{\frac {M_\text{ES} + M_\text{CS}} {M_\text{EC} + M_\text{CC}}} 
 \right),
$$

Variance was calculated as:

$$
\text{var}(\ln{\text{RR}_\text{stress}}) =
\left( 
\frac{1} { M_\text{ES} + M_\text{CS} } 
\right)^2
\left(
\frac{SD_\text{ES}^2}{N_\text{ES}} + \frac{SD_\text{CS}^2}{N_\text{CS}}
\right) + \left( \frac {1} {  M_\text{EC} +  M_\text{CC} } \right)^2
\left(\frac{SD_\text{EC}^2}{N_\text{EC}} + \frac{SD_\text{CC}^2}{N_\text{CC}}
\right)
$$ Variance was converted in to variance-covariance (VCV) matrix (see above in 'Data organisation') to control for non-independence in sampling variance from the same studies.

```{r}
mod_S0 <- rma.mv(yi = lnRR_Sa, V = VCV_S, random = list(~1|Study_ID,
                                                          ~1|ES_ID,
                                                          ~1|Strain),
                 test = "t", 
                 data = dat)

summary(mod_S0) 
i2_ml(mod_S0) 
```

Figure corresponds to Fig. 3A in main text

```{r}
orchard_plot(mod_S0, mod = "Int", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 
```

**Fig. S7** Orchard plot showing meta-analytic mean and 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision.

### Meta-regression: uni-moderator {.tabset}

To explain some of the unexplained variation in the main effect of stress model, we conducted a series of uni-moderator analyses. We calculated marginal R\^2 for each moderator as well as conducted a series of pair-wise contrasts between moderator categories.

Any moderator categories with k \< 5 were removed.

#### Learning vs Memory

Was the measured response interpreted as learning or memory?

```{r}

mod_S1 <-  rma.mv(yi = lnRR_Sa, V = VCV_S, mod = ~Learning_vs_memory-1, random = list(~1|Study_ID,
                                                                                        ~1|ES_ID,
                                                                                        ~1|Strain),
                  test = "t",
                  data = dat)

summary(mod_S1) 
r2_ml(mod_S1) 
```

Figure corresponds to Fig. 5A in main text

```{r, fig.width=10, fig.height=7}
LvsM_S <- orchard_plot(mod_S1, mod = "Learning_vs_memory", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
       text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

LvsM_S 
```

**Fig. S8a** Orchard plot showing the group-wise means of the categorical variable 'Learning_vs_memory' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_S1 <- contrast_fun(data = dat, response = lnRR_Sa, moderator = Learning_vs_memory, VCV = VCV_S)
res_table_mod_S1 <- get_estimate(model = mod_S1, contra = contra_mod_S1, moderator = Learning_vs_memory)

res_table_mod_S1
```

#### Type of assay

The broad category of the type of assay used to measure learning or memory.

```{r}
dat$Type_assay<-as.factor(dat$Type_assay)

VCV_S1 <- impute_covariance_matrix(vi = dat1$lnRRV_S, cluster = dat$Study_ID, r = 0.5)


mod_S2 <- rma.mv(yi = lnRR_Sa, V = VCV_S1, mod = ~Type_assay-1, random =   list(~1|Study_ID,
                                                                                    ~1|ES_ID,
                                                                                    ~1|Strain),
                 test = "t",
                 data = dat1)

summary(mod_S2)
r2_ml(mod_S2) 
```

Figure corresponds to Fig. 5B in main text

```{r, fig.width=10, fig.height=7}
Learning_S <- orchard_plot(mod_S2, mod = "Type_assay", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
    geom_signif(comparisons = list(c("Habituation", "Recognition")),
              annotations = "***") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

Learning_S
```

**Fig. S8b** Orchard plot showing the group-wise means of the categorical variable 'Type_assay' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_S2 <- contrast_fun(data = dat1, response = lnRR_Sa, moderator = Type_assay, VCV = VCV_S1)
res_table_mod_S2 <- get_estimate(model = mod_S2, contra = contra_mod_S2, moderator = Type_assay)

res_table_mod_S2
```

#### Type of reinforcement

If conditioning was used, was aversive or appetitive reinforcement used?

```{r}

VCV_S2 <- impute_covariance_matrix(vi = dat2$lnRRV_S, cluster = dat$Study_ID, r = 0.5)

mod_S3 <- rma.mv(yi = lnRR_Sa, V = VCV_S2, mod = ~ Type_reinforcement-1, random = list(~1|Study_ID,
                                                                                            ~1|ES_ID,
                                                                                            ~1|Strain),
                 test = "t",
                 data = dat2)

summary(mod_S3)
r2_ml(mod_S3) 
```

Figure corresponds to Fig. 5C in main text

```{r, fig.width=10, fig.height=7}
Reinforcement_S <- orchard_plot(mod_S3, mod = "Type_reinforcement", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
       text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

Reinforcement_S
```

**Fig. S8c** Orchard plot showing the group-wise means of the categorical variable 'Type_reinforcement' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individuals points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_S3 <- contrast_fun(data = dat2, response = lnRR_Sa, moderator = Type_reinforcement, VCV = VCV_S2)
res_table_mod_S3 <- get_estimate(model = mod_S3, contra = contra_mod_S3, moderator = Type_reinforcement)

res_table_mod_S3
```

#### Age at stress

The age when individuals were exposed to stress.

```{r}

mod_S4 <-rma.mv(yi = lnRR_Sa, V = VCV_S, mod = ~Age_stress_exposure-1, random = list(~1|Study_ID,
                                                                                       ~1|ES_ID,
                                                                                       ~1|Strain),
                test = "t",
                data = dat)
summary(mod_S4) 
r2_ml(mod_S4) 
```

Figure corresponds to Fig. 5D in main text

```{r, fig.width=10, fig.height=7}
Age_S <- orchard_plot(mod_S4, mod = "Age_stress_exposure", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34","grey34", "grey34")) +
  scale_fill_manual(values=c("grey34","grey34","grey34","grey34")) +
    geom_signif(comparisons = list(c("Adult", "Early postnatal")),
              annotations = "*") +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

Age_S 
```

**Fig. S8d** Orchard plot showing the group-wise means of the categorical variable 'Age_stress_exposure' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_S4 <- contrast_fun(data = dat, response = lnRR_Sa, moderator = Age_stress_exposure, VCV = VCV_S)
res_table_mod_S4 <- get_estimate(model = mod_S4, contra = contra_mod_S4, moderator = Age_stress_exposure)

res_table_mod_S4
```

#### Type of stress

The type of stress used.

```{r}
dat5 <- filter(dat, Type_stress_exposure %in% c("Restraint", "Noise", "Maternal separation", "Combination"))
VCV_S3 <- impute_covariance_matrix(vi = dat5$lnRRV_S, cluster = dat5$Study_ID, r = 0.5)

mod_S5 <- rma.mv(yi = lnRR_Sa, V = VCV_S3, mod = ~Type_stress_exposure-1, random = list(~1|Study_ID,
                                                                                         ~1|ES_ID,
                                                                                         ~1|Strain),
                 test = "t",
                 data = dat5)
summary(mod_S5) 
r2_ml(mod_S5)
```

Figure corresponds to Fig. 5E in main text

```{r, fig.width=10, fig.height=7}
Stressor<- orchard_plot(mod_S5, mod = "Type_stress_exposure", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34","grey34", "grey34")) +
  scale_fill_manual(values=c("grey34","grey34","grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

Stressor
```

**Fig. S8e** Orchard plot showing the group-wise means of the categorical variable 'Type_stress_exposure' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individuals points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_S5 <- contrast_fun(data = dat5, response = lnRR_Sa, moderator = Type_stress_exposure, VCV = VCV_S3)
res_table_mod_S5 <- get_estimate(model = mod_S5, contra = contra_mod_S5, moderator = Type_stress_exposure)

res_table_mod_S5
```

#### Stess duration

Was the stress acute or chronic?

```{r}
dat6 <- filter(dat, Stress_duration %in% c("Chronic", "Acute"))
VCV_S4 <- impute_covariance_matrix(vi = dat6$lnRRV_S, cluster = dat6$Study_ID, r = 0.5)

mod_S6 <-rma.mv(yi = lnRR_Sa, V = VCV_S4, mod = ~Stress_duration-1, random = list(~1|Study_ID,
                                                                                   ~1|ES_ID,
                                                                                   ~1|Strain),
                test = "t",
                data = dat6)
summary(mod_S6) 
r2_ml(mod_S6) 
```

Figure corresponds to Fig. 5F in main text

```{r, fig.width=10, fig.height=7}

Duration_S <- orchard_plot(mod_S6, mod = "Stress_duration", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

Duration_S 
```

**Fig. S8f** Orchard plot showing the group-wise means of the categorical variable 'Stress_duration' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individuals points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_S6 <- contrast_fun(data = dat6, response = lnRR_Sa, moderator =Stress_duration, VCV = VCV_S4)
res_table_mod_S6 <- get_estimate(model = mod_S6, contra = contra_mod_S6, moderator = Stress_duration)

res_table_mod_S6
```

### Publication bias & sensitivity analysis {.tabset}

#### Multi-moderator model

We ran a multi-moderator 'full' model of all moderators. We ran model selection based on AIC and selected the top set of models within delta AIC of 6 and calculated the importance of each moderator (i.e., Akaike weights) within this top model set.

```{r, eval = FALSE}

#selecting moderator levels with k >=5
dat_Sfm <- dat %>%
  filter(Type_assay %in% c("Recognition", "Habituation", "Conditioning"),
         Type_reinforcement %in% c("Appetitive", "Aversive", "Not applicable"),
         Type_stress_exposure %in% c("Restraint", "Noise", "Maternal separation", "Combination"),
         Stress_duration %in% c("Chronic", "Acute"))

#VCV_Sfm <- impute_covariance_matrix(vi = dat_Sfm$lnRRV_E, cluster = dat_Sfm$Study_ID, r = 0.5)
                 
mod_Sfm <- rma.mv(yi = lnRR_Sa, V = VCV_Sfm, mod = ~ Type_assay -1 + Learning_vs_memory + Type_reinforcement + Type_stress_exposure + Age_stress_exposure + Stress_duration, random =   list(~1|Study_ID,
                                                                                    ~1|ES_ID,
                                                                                    ~1|Strain),
                    test = "t",
                 data = dat_Sfm)
#summary(mod_Sfm)
#r2_ml(mod_Sfm) 

res_Sfm <- dredge(mod_Sfm, trace=2)
saveRDS(res_Sfm, file = here("Rdata", "res_Sfm.rds"))
# also saving the full model and data
saveRDS(mod_Sfm, file = here("Rdata", "mod_Sfm.rds"))
saveRDS(dat_Sfm, file = here("Rdata", "dat_Sfm.rds"))
```

The akaike weights for the top set of models with AIC \< 6

```{r}
dat_Sfm <- readRDS(file = here("Rdata", "dat_Sfm.rds"))
mod_Sfm <- readRDS(file = here("Rdata", "mod_Sfm.rds"))
res_Sfm <- readRDS(file = here("Rdata", "res_Sfm.rds"))
res_Sfm2<- subset(res_Sfm, delta <= 6, recalc.weights=FALSE)
importance(res_Sfm2) 
```

#### Funnel plot

We used funnel plots of effect sizes against the residuals of the full model to visually inspect for funnel asymmetry.

Figure corresponds to Fig. 7B in main text.

```{r}
# funnel plot
Funnel_S <- funnel(mod_Sfm, xlab = "lnRR", ylab = "Standard Error")
#Funnel_S
```

**Fig.S9** Funnel plot showing the standard error and residuals (lnRR) from the full model.

#### Egger's regression and time-lag bias

We fitted effective sample size calculated as:

$$
\sqrt{\frac {1} { \tilde{N} }}  =
\sqrt{\frac {1} { N_\text{ES}} + \frac{1}{N_\text{EC}} + 
\frac {1}{N_\text{CS}} + \frac{1}{N_\text{CC}}},
$$

and year of publication as moderators in the full model to inferentially test for funnel asymmetry and a decrease in effect sizes with publication year.

```{r}
#calculating inv effective sample size for use in full meta-regression
VCV_Sfm <- impute_covariance_matrix(vi = dat_Sfm$lnRRV_E, cluster = dat_Sfm$Study_ID, r = 0.5)

dat_Sfm$sqrt_inv_e_n <- with(dat_Sfm, sqrt(1/CC_n + 1/EC_n + 1/ES_n + 1/CS_n))

#time lag bias and eggers regression
dat_Sfm$c_Year_published <- as.vector(scale(dat_Sfm$Year_published, scale = F))

PB_MR_S<- rma.mv(lnRR_Sa, VCV_Sfm, mods = ~1 + sqrt_inv_e_n +  c_Year_published + Type_assay +Learning_vs_memory + Type_reinforcement + Type_stress_exposure + Age_stress_exposure + Stress_duration, random = list(~1|Study_ID,
                                                          ~1|ES_ID,
                                                          ~1|Strain), 
                 method = "REML", 
                 test = "t", 
                 data = dat_Sfm,
                  control=list(optimizer="optim", optmethod="Nelder-Mead"))

#PB_MR_S

estimates_PB_MR_S<- estimates.CI(PB_MR_S)
estimates_PB_MR_S

```

#### Leave-one-out sensitivity analysis

We individually removed studies to determine if any singular studies have a disproportionate effect on the meta-analytic mean and CI.

```{r}
# dat$Study_ID <- as.factor(dat$Study_ID)

LeaveOneOut_effectsize <- list()
for(i in 1:length(levels(dat$leave_out))){
  d <- dat %>% filter(leave_out != levels(dat$leave_out)[i])
  
  VCV_Sb <- impute_covariance_matrix(vi = d$lnRRV_E, cluster = d$Study_ID, r = 0.5)
  
  LeaveOneOut_effectsize[[i]] <- rma.mv(yi = lnRR_Sa, V = VCV_Sb, 
                                        random = list(~1 | Study_ID,~1| ES_ID, ~1 | Strain), 
                                        method = "REML", data = dat[dat$leave_out
                                                                    != levels(dat$leave_out)[i], ])}


# writing function for extracting est, ci.lb, and ci.ub from all models
est.func <- function(mod_S0){
  df <- data.frame(est = mod_S0$b, lower = mod_S0$ci.lb, upper = mod_S0$ci.ub)
  return(df)
}


#using dplyr to form data frame
MA_CVR_S <- lapply(LeaveOneOut_effectsize, function(x) est.func(x))%>% bind_rows %>% mutate(left_out = levels(dat$leave_out))

#saveRDS(MA_CVR_S,file = here("Rdata", "MA_CVR_S.rds"))

```

Figure corresponds to Fig. S4 in Supplementary material S2

```{r}
#MA_CVR_S <- readRDS(file = here("Rdata", "MA_CVR_S.rds"))

#telling ggplot to stop reordering factors
MA_CVR_S$left_out<- as.factor(MA_CVR_S$left_out)
MA_CVR_S$left_out<-factor(MA_CVR_S$left_out, levels = MA_CVR_S$left_out)

#plotting
leaveoneout_S <- ggplot(MA_CVR_S) +
  geom_hline(yintercept = 0, lty = 2, lwd = 1) +
  geom_hline(yintercept = mod_S0$ci.lb, lty = 3, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod_S0$b, lty = 1, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod_S0$ci.ub, lty = 3, lwd = 0.75, colour = "black") +
  geom_pointrange(aes(x = left_out, y = est, ymin = lower, ymax = upper)) +
  xlab("Study left out") + 
  ylab("lnRR, 95% CI") + 
  coord_flip() +
  theme(panel.grid.minor = element_blank())+
  theme_bw() + theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor.x = element_blank() ) +
  theme(axis.text.y = element_text(size = 6))

leaveoneout_S

#ggsave("leaveoneout_S.tiff", leaveoneout_S, dpi = 300) 

```

**Fig. S10** Leave-one-study-out analysis showing meta-analytic mean and 95% CI when each individual study is removed from the data set.

#### Using SMD

We re-ran the main effect of stress meta-analytic model using standardised mean difference (SMD) instead of lnRR.

```{r, message = FALSE, warning = FALSE}
mod_S0a <- rma.mv(yi = SMD_Sa, V = VCV_S_a, random = list(~1|Study_ID,
                                                         ~1|ES_ID,
                                                         ~1|Strain),
                test = "t",
                data = dat)
summary(mod_S0a) 
i2_ml(mod_S0a) 

```

#### Using untransformed percent data

We re-ran the main effect of stress meta-analytic model using un(arcsine)transformed percent data using lnRR.

```{r}
mod_S0b <- rma.mv(yi = lnRR_S_b, V = VCV_S_b, random = list(~1|Study_ID,
                                                         ~1|ES_ID, 
                                                         ~1|Strain),
                 test = "t",
                 data = dat)
summary(mod_S0b)
i2_ml(mod_S0b)
```


#### Risk of Bias

Including if the study was randomised as a moderator and conducting a pair-wise contrast.

```{r, results = 'hide'}
mod_randomised_S<- rma.mv(yi = lnRR_Sa, V = VCV_S, mod = ~ROB_randomisation-1, random = list(~1|Study_ID, 
                                                                             ~1|ES_ID,
                                                                             ~1|Strain),
                test = "t",data = dat)

summary(mod_randomised_S)
r2_ml(mod_randomised_S) 

```

```{r}
contra_mod_randomised_S <- contrast_fun(data = dat, response = lnRR_Sa, moderator = ROB_randomisation, VCV = VCV_S)
res_table_mod_randomised_S <- get_estimate(model = mod_randomised_S, contra = contra_mod_randomised_S, moderator = ROB_randomisation)

res_table_mod_randomised_S
```

Including if the study used blinding and conducting a pair-wise contrast.

```{r, results = 'hide'}
mod_blinding_S<- rma.mv(yi = lnRR_Sa, V = VCV_S, mod = ~ROB_blinding-1, random = list(~1|Study_ID, 
                                                                             ~1|ES_ID,
                                                                             ~1|Strain),
                test = "t",data = dat)

summary(mod_blinding_S)
r2_ml(mod_blinding_S) 

```

```{r}
contra_mod_blinding_S <- contrast_fun(data = dat, response = lnRR_Sa, moderator = ROB_blinding, VCV = VCV_S)
res_table_mod_blinding_S <- get_estimate(model = mod_blinding_S, contra = contra_mod_blinding_S, moderator = ROB_blinding)

res_table_mod_blinding_S
```

## Interaction: enrichment x stress

### Meta-analysis

To quantify differences in individual performance in cognitive assay with the interaction of environmental enrichment and stress, we used the logarithm of response ratio (lnRR) calculated as:

$$
\ln{\text{RR}_\text{interaction}} 
= \left(\ln M_\text{ES} -  \ln M_\text{CS}  \right) - 
\left( \ln M_\text{EC} -  \ln M_\text{CC} \right)
= 
\ln \left( \frac {M_\text{ES} / M_\text{CS} } 
{M_\text{EC} / \ M_\text{CC}} \right)
$$

Variance was calculated as:

$$
\text{var}(\ln{\text{RR}_\text{interaction}}) =
\frac {SD_\text{ES}^2} { N_\text{ES} M_\text{ES}^2 } + \frac{SD_\text{EC}^2}{N_\text{EC}M_\text{EC}^2} + 
\frac {SD_\text{CS}^2}{N_\text{CS} M_\text{CS}^2} + \frac{SD_\text{CC}^2}{N_\text{CC} M_\text{CC}^2}.
$$

Variance was converted into variance-covariance (VCV) matrix (see above in 'Data organisation') to control for non-independence in sampling variance from the same studies.

```{r}
mod_ES0 <- rma.mv(yi = lnRR_ESa, V = VCV_ES, random = list(~1|Study_ID,
                                                             ~1|ES_ID,
                                                             ~1|Strain),
                  test = "t", 
                  data = dat)

summary(mod_ES0) 
i2_ml(mod_ES0) 
```

Figure corresponds to Fig. 3A in main text

```{r}
orchard_plot(mod_ES0, mod = "Int", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  geom_point(aes(fill = name),  size = 5, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 24), # change font sizes
        legend.title = element_text(size = 15),
        legend.text = element_text(size = 13)) 
```

**Fig. S11** Orchard plot showing meta-analytic mean and 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

### Meta-regression: uni-moderator {.tabset}

To explain some of the unexplained variation in the interaction of environmental enrichment and stress, we conducted a series of uni-moderator analyses. We calculated marginal R\^2 for each moderator as well as conducted a series of pair-wise contrasts between moderator categories.

Any moderator categories with k \< 5 were removed.

#### Learning vs Memory

Was the response interpreted as learning or memory?

```{r}
mod_ES1 <-  rma.mv(yi = lnRR_ESa, V = VCV_ES, mod = ~Learning_vs_memory-1, random = list(~1|Study_ID, 
                                                                                           ~1|ES_ID,
                                                                                           ~1|Strain),
                   test = "t",
                   data = dat)

summary(mod_ES1) 
r2_ml(mod_ES1) 
```

Figure corresponds to Fig. 6A in main text

```{r, fig.width=10, fig.height=7}
LvsM_ES <- orchard_plot(mod_ES1, mod = "Learning_vs_memory", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10))

LvsM_ES 

# axis.text.x = element_text(size = 10), # change font sizes
#         axis.text.y = element_text(size = 10),
#         legend.title = element_text(size = 7),
#         legend.text = element_text(size = 7)) 
```

**Fig. S12a** Orchard plot showing the group-wise means of the categorical variable 'Learning_vs_memory' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_ES1 <- contrast_fun(data = dat, response = lnRR_ESa, moderator =Learning_vs_memory, VCV = VCV_ES)
res_table_mod_ES1 <- get_estimate(model = mod_ES1, contra = contra_mod_ES1, moderator = Learning_vs_memory)

res_table_mod_ES1
```

#### Type of assay

The broad category of the type of assay used to measure learning or memory.

```{r}
VCV_ES1 <- impute_covariance_matrix(vi = dat1$lnRRV_ES, cluster = dat$Study_ID, r = 0.5)

mod_ES2 <- rma.mv(yi = lnRR_ESa, V = VCV_ES1, mod = ~Type_assay-1, random = list(~1|Study_ID,
                                                                                    ~1|ES_ID,
                                                                                    ~1|Strain),
                  test = "t",
                  data = dat1)

summary(mod_ES2)
r2_ml(mod_ES2) 
```

Figure corresponds to Fig. 6B in main text

```{r, fig.width=10, fig.height=7}

Learning_ES <- orchard_plot(mod_ES2, mod = "Type_assay", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34","grey34")) +
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
    geom_signif(comparisons = list(c("Conditioning", "Recognition")),
              annotations = "*") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10)) 

Learning_ES
```

**Fig. S12b** Orchard plot showing the group-wise means of the categorical variable 'Type_assay' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_ES2 <- contrast_fun(data = dat1, response = lnRR_ESa, moderator =Type_assay, VCV = VCV_ES1)
res_table_mod_ES2 <- get_estimate(model = mod_ES2, contra = contra_mod_ES2, moderator = Type_assay)

res_table_mod_ES2
```

#### Type of reinforcement

If conditioning was used, was aversive or appetitive reinforcement used?

```{r}
VCV_ES2 <- impute_covariance_matrix(vi = dat2$lnRRV_ES, cluster = dat2$Study_ID, r = 0.5)

mod_ES3 <- rma.mv(yi = lnRR_ESa, V = VCV_ES2, mod = ~ Type_reinforcement-1, random = list(~1|Study_ID,
                                                                                               ~1|ES_ID,
                                                                                               ~1|Strain),
                  test = "t",
                  data = dat2)

summary(mod_ES3)
r2_ml(mod_ES3) 
```

Figure corresponds to Fig. 6C in main text

```{r, fig.width=10, fig.height=7}
Reinforcement_ES <- orchard_plot(mod_ES3, mod = "Type_reinforcement", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34","grey34")) +
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
    geom_signif(comparisons = list(c("Aversive", "Not applicable")),
              annotations = "*") +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10)) 

Reinforcement_ES 
```

**Fig. S12c** Orchard plot showing the group-wise means of the categorical variable 'Type_reinforcement' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_ES3 <- contrast_fun(data = dat2, response = lnRR_ESa, moderator =Type_reinforcement, VCV = VCV_ES2)
res_table_mod_ES3 <- get_estimate(model = mod_ES3, contra = contra_mod_ES3, moderator = Type_reinforcement)

res_table_mod_ES3
```

#### Age at enrichment

The age when individuals were exposed to environmental enrichment.

```{r}
VCV_ES3 <- impute_covariance_matrix(vi = dat3$lnRRV_ES, cluster = dat3$Study_ID, r = 0.5)

mod_ES4 <- rma.mv(yi = lnRR_ESa, V = VCV_ES3, mod = ~Age_EE_exposure-1, random = list(~1|Study_ID,
                                                                                    ~1|ES_ID,
                                                                                    ~1|Strain),
                 test = "t",
                 data = dat3)

summary(mod_ES4) 
r2_ml(mod_ES4) 
```

Figure corresponds to Fig. 6D in main text

```{r, fig.width=10, fig.height=7}
Age_enrichment_ES <- orchard_plot(mod_ES4, mod = "Age_EE_exposure", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
       axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10)) 

Age_enrichment_ES
```

**Fig. S12d** Orchard plot showing the group-wise means of the categorical variable 'Age_EE_exposure' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_ES4 <- contrast_fun(data = dat3, response = lnRR_ESa, moderator =Age_EE_exposure, VCV = VCV_ES3)
res_table_mod_ES4 <- get_estimate(model = mod_ES4, contra = contra_mod_ES4, moderator = Age_EE_exposure)

res_table_mod_ES4
```

#### Age at stress

The age when individuals were exposed to stress.

```{r}
mod_ES7 <-rma.mv(yi = lnRR_ESa, V = VCV_ES, mod = ~Age_stress_exposure-1, random = list(~1|Study_ID,
                                                                                          ~1|ES_ID,
                                                                                          ~1|Strain),
                 test = "t",
                 data = dat)
summary(mod_ES7) 
r2_ml(mod_ES7) 
```

Figure corresponds to Fig. 6E in main text

```{r, fig.width=10, fig.height=7}

Age_stress_ES<-orchard_plot(mod_ES7, mod = "Age_stress_exposure", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34","grey34", "grey34")) +
  scale_fill_manual(values=c("grey34","grey34","grey34","grey34")) +
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
       axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10))

Age_stress_ES
```

**Fig. S12e** Orchard plot showing the group-wise means of the categorical variable 'Age_stress_exposure' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_ES7 <- contrast_fun(data = dat, response = lnRR_ESa, moderator =Age_stress_exposure, VCV = VCV_ES)
res_table_mod_ES7 <- get_estimate(model = mod_ES7, contra = contra_mod_ES7, moderator = Age_stress_exposure)

res_table_mod_ES7
```

#### Order to treatment exposure

The order in which individuals were exposed to enrichment and stress.

```{r}
mod_ES10 <- rma.mv(yi = lnRR_ESa, V = VCV_ES, mod = ~Exposure_order -1, random = list(~1|Study_ID, 
    ~1|ES_ID,
    ~1|Strain),
     test = "t",
     data = dat)

summary(mod_ES10)
r2_ml(mod_ES10)
```

Figure corresponds to Fig. 6F in main text

```{r, fig.width=10, fig.height=7}

Order_ES <- orchard_plot(mod_ES10, mod = "Exposure_order", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34","grey34")) +
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10))

Order_ES 
```

**Fig. S12f** Orchard plot showing the group-wise means of the categorical variable 'Exposure_order' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_ES10 <- contrast_fun(data = dat, response = lnRR_ESa, moderator =Exposure_order, VCV = VCV_ES)
res_table_mod_ES10 <- get_estimate(model = mod_ES10, contra = contra_mod_ES10, moderator = Exposure_order)

res_table_mod_ES10
```

#### Exercise enrichment

Did enrichment involve the addition of apparatus for voluntary exercise in the cage (e.g., a wheel or treadmill)?

```{r}
mod_ES5<- rma.mv(yi = lnRR_ESa, V = VCV_ES, mod = ~EE_exercise-1, random = list(~1|Study_ID, 
    ~1|ES_ID,
    ~1|Strain),
     test = "t",
     data = dat)

summary(mod_ES5)
r2_ml(mod_ES5) 
```

Figure corresponds to Fig. 6G in main text

```{r, fig.width=10, fig.height=7}
Exercise_ES <- orchard_plot(mod_ES5, mod = "EE_exercise", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
      axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10)) 

Exercise_ES
```

**Fig. S12g** Orchard plot showing the group-wise means of the categorical variable 'EE_exercise' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_ES5 <- contrast_fun(data = dat, response = lnRR_ESa, moderator =EE_exercise, VCV = VCV_ES)
res_table_mod_ES5 <- get_estimate(model = mod_ES5, contra = contra_mod_ES5, moderator = EE_exercise)

res_table_mod_ES5
```

#### Social enrichment

Did enrichment involve adding more conspecifics in the cage? (Note that we did not include studies that only provided social enrichment but no other form of abiotic enrichment.)

```{r}
VCV_ES4 <- impute_covariance_matrix(vi = dat4$lnRRV_ES, cluster = dat4$Study_ID, r = 0.5)
mod_ES6<- rma.mv(yi = lnRR_ESa, V = VCV_ES4, mod = ~EE_social-1, random = list(~1|Study_ID,
                                                                                ~1|ES_ID,
                                                                                ~1|Strain),
                 test = "t",
                 data = dat4)

summary(mod_ES6)
r2_ml(mod_ES6) 
```

Figure corresponds to Fig. 5H in main text

```{r, fig.width=10, fig.height=7}
Social_ES <- orchard_plot(mod_ES6, mod = "EE_social", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
     axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10))

Social_ES
```

**Fig. 6h** Orchard plot showing the group-wise means of the categorical variable 'EE_social' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes. .

##### Contrasts

```{r}
contra_mod_ES6 <- contrast_fun(data = dat4, response = lnRR_ESa, moderator =EE_social, VCV = VCV_ES4)
res_table_mod_ES6 <- get_estimate(model = mod_ES6, contra = contra_mod_ES6, moderator = EE_social)

res_table_mod_ES6
```

#### Type of stress

The type of stressor used.

```{r}
VCV_ES5 <- impute_covariance_matrix(vi = dat5$lnRRV_ES, cluster = dat5$Study_ID, r = 0.5)
mod_ES8 <- rma.mv(yi = lnRR_ESa, V = VCV_ES5, mod = ~Type_stress_exposure-1, random = list(~1|Study_ID,
                                                                                            ~1|ES_ID,
                                                                                            ~1|Strain),
                  test = "t",
                  data = dat5)
summary(mod_ES8)
r2_ml(mod_ES8)
```

Figure corresponds to Fig. 6I in main text

```{r, fig.width=10, fig.height=7}
Stressor_ES <- orchard_plot(mod_ES8, mod = "Type_stress_exposure", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  scale_colour_manual(values = c("grey34","grey34","grey34", "grey34")) +
  scale_fill_manual(values=c("grey34","grey34","grey34","grey34")) +
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
       axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10))  

Stressor_ES 
```

**Fig. S12I** Orchard plot showing the group-wise means of the categorical variable 'Type_stress_exposure' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_ES8 <- contrast_fun(data = dat5, response = lnRR_ESa, moderator =Type_stress_exposure, VCV = VCV_ES5)
res_table_mod_ES8 <- get_estimate(model = mod_ES8, contra = contra_mod_ES8, moderator = Type_stress_exposure)

res_table_mod_ES8
```

#### Stress duration

Was the stress acute or chronic?

```{r}
VCV_ES6 <- impute_covariance_matrix(vi = dat6$lnRRV_ES, cluster = dat6$Study_ID, r = 0.5)

mod_ES9 <-rma.mv(yi = lnRR_ESa, V = VCV_ES6, mod = ~Stress_duration-1, random = list(~1|Study_ID,
                                                                                      ~1|ES_ID,
                                                                                      ~1|Strain),
                 test = "t",
                 data = dat6)
summary(mod_ES9) 
r2_ml(mod_ES9) 
```

Figure corresponds to Fig. 6J in main text

```{r, fig.width=10, fig.height=7}

Duration_ES<- orchard_plot(mod_ES9, mod = "Stress_duration", xlab = "lnRR", alpha=0.4) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals
  geom_point(aes(fill = name),  size = 3, shape = 21)+ # mean estimate
  scale_colour_manual(values = c("grey34","grey34")) +
  scale_fill_manual(values=c("grey34","grey34")) +
    geom_signif(comparisons = list(c("Acute", "Chronic")),
              annotations = "*") +
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
      axis.text.x = element_text(size = 15), # change font sizes
        axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 10))

Duration_ES
```

**Fig. S12j** Orchard plot showing the group-wise means of the categorical variable 'Stress_duration' with their 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

##### Contrasts

```{r}
contra_mod_ES9 <- contrast_fun(data = dat6, response = lnRR_ESa, moderator =Stress_duration, VCV = VCV_ES6)
res_table_mod_ES9 <- get_estimate(model = mod_ES9, contra = contra_mod_ES9, moderator = Stress_duration)

res_table_mod_ES9
```

### Publication bias & sensitivity analysis {.tabset}

#### Multi-moderator model

We ran a multi-moderator 'full' model of all moderators. We ran model selection based on AIC and selected the top set of models within delta AIC of 6 and calculated the importance of each moderator (i.e., Akaike weights) within this top model set.

```{r, eval = FALSE}
dat_ESfm <- dat %>%
  filter(Type_assay %in% c("Recognition", "Habituation", "Conditioning"),
         Type_reinforcement %in% c("Appetitive", "Aversive", "Not applicable"),
         EE_social %in% c("Social", "Non-social"),
         Age_EE_exposure %in% c("Adult", "Adolescent"),
         Type_stress_exposure %in% c("Restraint", "Noise", "Maternal separation", "Combination"),
         Stress_duration %in% c("Chronic", "Acute"), 
         Age_stress_exposure %in% c("Prenatal", "Early postnatal", "Adult"))

#VCV_ESfm <- impute_covariance_matrix(vi = dat_ESfm$lnRRV_ES, cluster = dat_ESfm$Study_ID, r = 0.5)
                 
mod_ESfm <- rma.mv(yi = lnRR_Sa, V = VCV_ESfm, mod = ~Type_assay-1 + Learning_vs_memory + Type_reinforcement + EE_social + EE_exercise + Age_EE_exposure + Type_stress_exposure + Age_stress_exposure + Stress_duration + Exposure_order, random =   list(~1|Study_ID,
                                                                                    ~1|ES_ID,
                                                                                    ~1|Strain),
                    test = "t",
                 data = dat_ESfm)
#summary(mod_ESfm)
#r2_ml(mod_ESfm) 


res_ESfm <- dredge(mod_ESfm, trace=2)
saveRDS(res_ESfm, file = here("Rdata", "res_ESfm.rds"))
# also saving the full model and data
saveRDS(mod_ESfm, file = here("Rdata", "mod_ESfm.rds"))
saveRDS(dat_ESfm, file = here("Rdata", "dat_ESfm.rds"))
```

Akaike weights for the top set of models with AIC \< 6

```{r}
dat_ESfm <- readRDS(file = here("Rdata", "dat_ESfm.rds"))
mod_ESfm <- readRDS(file = here("Rdata", "mod_ESfm.rds"))
res_ESfm <- readRDS(file = here("Rdata", "res_ESfm.rds"))
res_ESfm2<- subset(res_ESfm, delta <= 6, recalc.weights=FALSE)
importance(res_ESfm2) 
```

#### Funnel plot

We used funnel plots of effect sizes against the residuals of the full model to visually inspect for funnel asymmetry.

Figure corresponds to Fig. 7C in main text

```{r}
Funnel_ES<-funnel(mod_ESfm, xlab = "lnRR", ylab = "Standard Error")
#Funnel_ES
```

**Fig.S13** Funnel plot showing the standard error and residuals (lnRR) from the full model.

#### Egger's regression and time-lag bias

We fitted effective sample size calculated as:

$$
\sqrt{\frac {1} { \tilde{N} }}  =
\sqrt{\frac {1} { N_\text{ES}} + \frac{1}{N_\text{EC}} + 
\frac {1}{N_\text{CS}} + \frac{1}{N_\text{CC}}},
$$

and year of publication as moderators in the full model to inferentially test for funnel asymmetry and a decrease in effect sizes with publication year.

```{r}
#calculating inv effective sample size for use in full meta-regression
dat_ESfm$sqrt_inv_e_n <- with(dat_ESfm, sqrt(1/CC_n + 1/EC_n + 1/ES_n + 1/CS_n))
dat_ESfm$c_Year_published <- as.vector(scale(dat_ESfm$Year_published, scale = F))

VCV_ESfm <- impute_covariance_matrix(vi = dat_ESfm$lnRRV_ES, cluster = dat_ESfm$Study_ID, r = 0.5)
              

#time lag bias and Egger's regression.  

PB_MR_ES<- rma.mv(lnRR_ESa, VCV_ESfm, mods = ~1 + sqrt_inv_e_n +  c_Year_published + Type_assay +Learning_vs_memory + Type_reinforcement + Type_stress_exposure + Age_stress_exposure + EE_social + EE_exercise + Stress_duration + Exposure_order, random = list(~1|Study_ID,
                                                          ~1|ES_ID,
                                                          ~1|Strain), 
                 method = "REML", 
                 test = "t", 
                 data = dat_ESfm,
                  control=list(optimizer="optim", optmethod="Nelder-Mead"))


estimates_PB_MR_ES<- estimates.CI(PB_MR_ES)
estimates_PB_MR_ES

```

#### Leave-one-out analysis

We individually removed studies to determine if any singular studies have a disproportionate effect on the meta-analytic mean and CI.

```{r}
LeaveOneOut_effectsize <- list()
for(i in 1:length(levels(dat$leave_out))){
  d <- dat %>% filter(leave_out != levels(dat$leave_out)[i])
  
  VCV_ESb <- impute_covariance_matrix(vi = d$lnRRV_ES, cluster = d$Study_ID, r = 0.5)
  LeaveOneOut_effectsize[[i]] <- rma.mv(yi = lnRR_ESa, V = VCV_ESb, 
                                        random = list(~1 | Study_ID,~1| ES_ID, ~1 | Strain), 
                                        method = "REML", data = dat[dat$leave_out
                                                                    != levels(dat$leave_out)[i], ])}


# writing function for extracting est, ci.lb, and ci.ub from all models
est.func <- function(mod_ES0){
  df <- data.frame(est = mod_ES0$b, lower = mod_ES0$ci.lb, upper = mod_ES0$ci.ub)
  return(df)
}


#using dplyr to form data frame
MA_CVR_ES <- lapply(LeaveOneOut_effectsize, function(x) est.func(x))%>% bind_rows %>% mutate(left_out = levels(dat$leave_out))

#saveRDS(MA_CVR_ES, ,file = here("Rdata", "MA_CVR_ES.rds"))

```

Figure corresponds to Fig. S5 in Supplementary material S2

```{r}
#MA_CVR_ES<- readRDS(here("Rdata", "MA_CVR_ES.rds"))

#telling ggplot to stop reordering factors
MA_CVR_ES$left_out<- as.factor(MA_CVR_ES$left_out)
MA_CVR_ES$left_out<-factor(MA_CVR_ES$left_out, levels = MA_CVR_ES$left_out)

#plotting
leaveoneout_ES <- ggplot(MA_CVR_ES) +
  geom_hline(yintercept = 0, lty = 2, lwd = 1) +
  geom_hline(yintercept = mod_ES0$ci.lb, lty = 3, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod_ES0$b, lty = 1, lwd = 0.75, colour = "black") +
  geom_hline(yintercept = mod_ES0$ci.ub, lty = 3, lwd = 0.75, colour = "black") +
  geom_pointrange(aes(x = left_out, y = est, ymin = lower, ymax = upper)) +
  xlab("Study left out") + 
  ylab("lnRR, 95% CI") + 
  coord_flip() +
  theme(panel.grid.minor = element_blank())+
  theme_bw() + theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor.x = element_blank() ) +
  theme(axis.text.y = element_text(size = 6))

leaveoneout_ES

#ggsave("leaveoneout_ES.tiff", leaveoneout_ES, dpi = 300) 

```

**Fig. S14** Leave-one-group-out analysis showing meta-analytic mean and 95% CI when each individual study is removed from the data set.

#### Using SMD

We re-ran the interaction of environmental enrichment x stress meta-analytic model using standardised mean difference (SMD) instead of lnRR.

```{r, message = FALSE, warning = FALSE}
mod_ES0a <- rma.mv(yi = SMD_ESa, V = VCV_ES_a, random = list(~1|Study_ID,
                                                            ~1|ES_ID,
                                                            ~1|Strain),
                  test = "t",
                  data = dat)
summary(mod_ES0a)
i2_ml(mod_ES0a) 

```

#### Using untransformed percent data

We re-ran the main effect of environmental enrichment x stress meta-analytic model using un(arcsine)transformed percent data using lnRR.

```{r}
mod_ES0b <- rma.mv(yi = lnRR_ES_b, V = VCV_ES_b, random = list(~1|Study_ID,
                                                         ~1|ES_ID, 
                                                         ~1|Strain),
                 test = "t",
                 data = dat)
summary(mod_ES0b)
i2_ml(mod_ES0b)
```


#### Risk of Bias

Including if the study was randomised as a moderator and conducting a pair-wise contrast.

```{r, results = 'hide'}
mod_randomised_ES<- rma.mv(yi = lnRR_ESa, V = VCV_ES, mod = ~ROB_randomisation-1, random = list(~1|Study_ID, 
                                                                             ~1|ES_ID,
                                                                             ~1|Strain),
                test = "t",data = dat)

summary(mod_randomised_ES)
r2_ml(mod_randomised_ES) 

```

```{r}
contra_mod_randomised_ES <- contrast_fun(data = dat, response = lnRR_ESa, moderator = ROB_randomisation, VCV = VCV_ES)
res_table_mod_randomised_ES <- get_estimate(model = mod_randomised_ES, contra = contra_mod_randomised_ES, moderator = ROB_randomisation)

res_table_mod_randomised_ES
```

Including if the study used blinding and conducting a pair-wise contrast

```{r, results = 'hide'}
mod_blinding_ES<- rma.mv(yi = lnRR_ESa, V = VCV_ES, mod = ~ROB_blinding-1, random = list(~1|Study_ID, 
                                                                             ~1|ES_ID,
                                                                             ~1|Strain),
                test = "t",data = dat)

summary(mod_blinding_ES)
r2_ml(mod_blinding_ES) 

```

```{r}
contra_mod_blinding_ES <- contrast_fun(data = dat, response = lnRR_ESa, moderator = ROB_blinding, VCV = VCV_ES)
res_table_mod_blinding_ES <- get_estimate(model = mod_blinding_ES, contra = contra_mod_blinding_ES, moderator = ROB_blinding)

res_table_mod_blinding_ES
```

## 'Pairwise' effect sizes {.tabset}

We conducted five 'meta-analyses on 'pair-wise' comparisons using lnRR between the treatments and control:\
$$
\ln{\text{RR}} = \ln (M_{\text{EC}}/M_{\text{CC}}), 
\ln (M_{\text{CS}}/M_{\text{CC}}), 
\ln (M_{\text{ES}}/M_{\text{CC}}), 
\ln (M_{\text{ES}}/M_{\text{CS}})
\ln (M_{\text{ES}}/M_{\text{EC}}), 
$$

### Enrichment relative to control

$$
\ln{\text{RR}} = \ln (M_{\text{EC}}/M_{\text{CC}})
$$

```{r}

VCV_E20 <- impute_covariance_matrix(vi = dat$lnRRV_E2, cluster = dat$Study_ID, r = 0.5)

mod_E20 <- rma.mv(yi = lnRR_E2a, V = VCV_E20, random = list(~1|Study_ID,
                                                             ~ 1|Strain,
                                                             ~1|ES_ID),
                 test = "t", 
                 data = dat, 
                 control=list(optimizer="optim", optmethod="Nelder-Mead"))

summary(mod_E20) 
i2_ml(mod_E20)

```

Figure corresponds to Fig. 3B in main text

```{r, fig.width=10, fig.height=7}
orchard_plot(mod_E20, mod = "Int", xlab = "lnRR")
```

**Fig. S15a** Orchard plot showing meta-analytic mean and 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

### Stress relative to control

$$
\ln{\text{RR}} = \ln (M_{\text{CS}}/M_{\text{CC}})
$$

```{r}
VCV_S20 <- impute_covariance_matrix(vi = dat$lnRRV_S2, cluster = dat$Study_ID, r = 0.5)

mod_S20 <- rma.mv(yi = lnRR_S2a, V = VCV_S20, random = list(~1|Study_ID, 
                                                             ~ 1|Strain,
                                                             ~1|ES_ID),
                 test = "t",
                 data = dat)

summary(mod_S20) 
i2_ml(mod_S20) 
```

Figure corresponds to Fig. 3B in main text

```{r, fig.width=10, fig.height=7}
orchard_plot(mod_S20, mod = "Int", xlab = "lnRR")
```

**Fig. S15b** Orchard plot showing meta-analytic mean and 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

### Enrichment + stress relative to control

$$
\ln{\text{RR}} = \ln (M_{\text{ES}}/M_{\text{CC}})
$$

```{r}
VCV_ES20 <- impute_covariance_matrix(vi = dat$lnRRV_ES2, cluster = dat$Study_ID, r = 0.5)

mod_ES20 <- rma.mv(yi = lnRR_ES2a, V = VCV_ES20, random = list(~1|Study_ID,
                                                                ~ 1|Strain,
                                                                ~1|ES_ID),
                 test = "t",
                 data = dat)
summary(mod_ES20) 
i2_ml(mod_ES20) 
```

Figure corresponds to Fig. 3B in main text

```{r, fig.width=10, fig.height=7}
orchard_plot(mod_ES20, mod = "Int", xlab = "lnRR")
```

**Fig. S15c** Orchard plot showing meta-analytic mean and 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

### Enrichment + stress relative to stress

$$
\ln{\text{RR}} = \ln (M_{\text{ES}}/M_{\text{CS}})
$$

```{r}
VCV_E30 <- impute_covariance_matrix(vi = dat$lnRRV_E3, cluster = dat$Study_ID, r = 0.5)

mod_E30 <- rma.mv(yi = lnRR_E3a, V = VCV_E30, random = list(~1|Study_ID,
                                                             ~ 1|Strain,
                                                             ~1|ES_ID),
                  test = "t",
                  data = dat)
summary(mod_E30) 
i2_ml(mod_E30) 
```

Figure corresponds to Fig. 3B in main text

```{r, fig.width=10, fig.height=7}
orchard_plot(mod_E30, mod = "Int", xlab = "lnRR")
```

**Fig. S15d** Orchard plot showing meta-analytic mean and 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

### Enrichment + stress relative to enrichment

$$
\ln{\text{RR}} = \ln (M_{\text{ES}}/M_{\text{EC}})
$$

```{r}
VCV_S30 <- impute_covariance_matrix(vi = dat$lnRRV_S3, cluster =
                                      dat$Study_ID, r = 0.5)

mod_S30 <- rma.mv(yi = lnRR_S3a, V = VCV_S30, random = list(~1|Study_ID,
                                                             ~ 1|Strain,
                                                             ~1|ES_ID),
                  test = "t",
                  data = dat,
                   control=list(optimizer="optim", optmethod="Nelder-Mead"))
summary(mod_S30) 
i2_ml(mod_S30) 
```

Figure correspinds to Fig. 3B in main text

```{r, fig.width=10, fig.height=7}
orchard_plot(mod_S30, mod = "Int", xlab = "lnRR")
```

**Fig. S15e** Orchard plot showing meta-analytic mean and 95% confidence interval (thick black line) and 95% prediction interval (thin black line). Individual points show observed effect sizes scaled proportionately to their precision. k is number of effect sizes.

## Figures

### Panel of 'focal' ES and 'pairwise' ES orchard plots

Figure corresponds to Fig.3 in main text

```{r}
mod_list1 <- list(mod_E0, mod_S0, mod_ES0)

mod_res1 <- lapply(mod_list1, function(x) mod_results(x, mod = "Int"))

merged1 <- submerge(mod_res1[[3]], mod_res1[[2]],  mod_res1[[1]], mix = T)
merged1$mod_table$name <- factor(merged1$mod_table$name, levels = c("Intrcpt1", 
    "Intrcpt2", "Intrcpt3"), 
    labels = rev(c("Enrichment ME", "Stress ME", "Interaction")))

merged1$data$moderator <- factor(merged1$data$moderator, levels = c("Intrcpt1", 
    "Intrcpt2", "Intrcpt3"), 
    labels = rev(c("Enrichment ME", "Stress ME", "Interaction")))

orchard1 <- orchard_plot(merged1, mod = "Int", xlab = "lnRR", angle = 0) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals 
  xlim(-2,4.5) +
  geom_point(aes(fill = name),  size = 4, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling +
  scale_colour_manual(values = rev(c("#00A651", "#00AEEF", "#ED1C24")))+ 
  scale_fill_manual(values = rev(c("#00A651", "#00AEEF", "#ED1C24")))+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

```

```{r}

mod_list2 <- list(mod_S30, mod_E30, mod_ES20, mod_S20, mod_E20) #rearranged the order so that it matches intext results

mod_res2 <- lapply(mod_list2, function(x) mod_results(x, mod = "Int"))

merged2 <- submerge(mod_res2[[1]], mod_res2[[2]],  mod_res2[[3]], mod_res2[[4]],  mod_res2[[5]], mix = T)

merged2$mod_table$name <- factor(merged2$mod_table$name, levels = c("Intrcpt1", 
    "Intrcpt2", "Intrcpt3", "Intrcpt4", "Intrcpt5"), 
    labels = rev(c("EC/CC", "CS/CC", "ES/CC", "ES/CS", "ES/EC")))

merged2$data$moderator <- factor(merged2$data$moderator, levels = c("Intrcpt1", 
    "Intrcpt2", "Intrcpt3", "Intrcpt4", "Intrcpt5"), 
    labels = rev(c("EC/CC", "CS/CC", "ES/CC", "ES/CS", "ES/EC")))

orchard2 <- orchard_plot(merged2, mod = "Int", xlab = "lnRR", angle = 0) + 
  geom_errorbarh(aes(xmin = lowerPR, xmax = upperPR), height = 0, show.legend = FALSE, size = 1.1, alpha = 0.5) + # prediction intervals
  geom_errorbarh(aes(xmin = lowerCL, xmax = upperCL), height = 0.05, show.legend = FALSE, size = 2) + # confidence intervals 
  xlim(-2,4.5) +
  geom_point(aes(fill = name),  size = 4, shape = 21)+ # mean estimate
  scale_size_continuous(range = c(1, 7))+ # change point scaling
  scale_colour_manual(values = c("#7B81BE","#D7DF23","#F37158","#75CBF2","#97D2B4"))+ # change colours
  scale_fill_manual(values=c("#7B81BE","#D7DF23","#F37158","#75CBF2","#97D2B4"))+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1.3), # border around the plot
        text = element_text(size = 15), # change font sizes
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)) 

```

```{r, fig.width=15, fig.height=7}

p1 <- orchard1 + orchard2 +  plot_annotation(tag_levels = 'A')
p1

#saved as PDF: 6 x 15 inches.  

```

**Fig. S16** Orchard plots showing the eight meta-analytic models. (A) main effects of enrichment and stress, and interaction of environmental enrichment and stress, (B) 'pairwise' comparisons between treatments and controls. Thick black lines = 95% CI, thin black lines = 95 % PI. Individual effect sizes are shown as circles scaled proportionately to their precision. k is number of effect sizes.

### Panel of meta-regressions {.tabset}

#### Environmental enrichment

Figure corresponds to Fig. 4 in main text

```{r, fig.width=15, fig.height=7}
#Enrichment
E_mod <- (LvsM_E + Learning_E + Reinforcement_E)/ (Age_E + Exercise_E + Social_E) +  plot_annotation(tag_levels = 'A')

E_mod
#saved as pdf 10 x 15 inches
```

**Fig. S17** Orchard plots showing the six different meta-regressions on the main effect of environmental enrichment on learning and memory. (A) learning versus memory response, (B) the type of assay, (C) the type of reinforcement, (D) the age at environmental enrichment, (E) type of manipulation of exercise during enrichment, (F) manipulation of the social environment during enrichment. Individual efect sizes are shown as circles scaled proportionately to their precision. k is number of effect sizes.

#### Stress

Figure corresponds to Fig. 5 in main text

```{r,  fig.width=15, fig.height=7}
S_mod <- (LvsM_S + Learning_S + Reinforcement_S) / (Age_S + Stressor + Duration_S) + plot_annotation(tag_levels = 'A')

S_mod
#saved as pdf 10 x 15 inches
```

**Fig. S18** Orchard plots showing the six different meta-regressions on the main effect of stress on learning and memory. (A) learning versus memory response, (B) the type of assay, (C) the type of reinforcement, (D) the age at stress, (E) the type of stressor, (F) chronic or acute stress. Individual effect sizes are shown as circles scaled proportionately to their precision. k is number of effect sizes.

#### Interaction

Figure corresponds to Fig. 6 in main text

```{r, fig.width=20, fig.height=10}
ES_mod <- plot_grid(LvsM_ES, Learning_ES, Reinforcement_ES, Age_enrichment_ES, Age_stress_ES, Order_ES, Exercise_ES, Social_ES, Stressor_ES, Duration_ES,
  labels = "AUTO", ncol = 5)

ES_mod
#saved as 10 x 25 inches
```

**Fig. S19** Orchard plots showing the 10 different meta-regressions of moderators on the interaction between environmental enrichment and stress learning and memory. (A) learning versus memory response, (B) the type of assay, (C) the type of reinforcement used, (D) the age at environmental enrichment, (E) the age at stress, (F) the order of treatment exposure, (G) if enrichment involved a manipulation of exercise, (H) manipulation of the social environment during enrichment, (I) the type of stressor, (F) stress was chronic or acute. Individual effect sizes are shown as circles scaled proportionately to their precision. k is number of effect sizes.

### Panel of funnel plots

Figure corresponds to Fig. 7 in main text

```{r, fig.show = 'hide'}
# EE

pdf(NULL)
dev.control(displaylist="enable")
par(mar=c(4,4,0.1,0))
A <- funnel(mod_Efm, xlab = "Residuals (lnRR)", ylab = "Standard Error",
        xlim = c(-2,2),
        ylim = c(0,1.05))
A <- recordPlot()
invisible(dev.off())

# Stress

pdf(NULL)
dev.control(displaylist="enable")
par(mar=c(4,4,0.1,0))
B <- funnel(mod_Sfm, xlab = "Residuals (lnRR)", ylab = "Standard Error",
        xlim = c(-2,2),
        ylim = c(0,1.05))
B <- recordPlot()
invisible(dev.off())

# Interaction
pdf(NULL)
dev.control(displaylist="enable")
par(mar=c(4,4,0.1,0))
C <- funnel(mod_ESfm, xlab = "Residuals (lnRR)", ylab = "Standard Error",
        xlim = c(-2,2),
        ylim = c(0,1.05))
C <- recordPlot()
invisible(dev.off())
```

```{r}
ggdraw(A) + ggdraw(B) + ggdraw(C) + plot_annotation(tag_levels = 'A')
```

**Fig. S20** Funnel plots of the standard error and residuals (lnRR) from the full models. (A) environmental enrichment main effect, (B) stress main effect, (C) environmental enrichment x stress interaction.

# Software and package versions

```{r}
sessionInfo() %>% pander()
```
